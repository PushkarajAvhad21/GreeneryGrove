<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreeneryGrove Dashboard</title>
    <link rel="stylesheet" href="/index/dashboard.css">
    <link rel="stylesheet" href="/index/dashboard_responsive.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 50%;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #4CAF50;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 10px;
        }

        input,
        textarea {
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            padding: 10px;
            margin-top: 20px;
            background-color: #4CAF50;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .main-container {
            display: flex;
        }

        .navcontainer {
            width: 20%;
            background-color: #333;
            color: black;
            height: 100vh;
            padding-top: 20px;
        }

        .nav {
            list-style: none;
            padding: 0;
        }

        .nav-option {
            padding: 10px 20px;
            cursor: pointer;
        }

        .nav-option:hover {
            background-color: #575757;
            color: white;
        }

        .main {
            width: 80%;
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .product-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            width: calc(25% - 32px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: inline-block;
            vertical-align: top;
        }

        .product-card img {
            max-width: 100%;
            border-radius: 8px;
        }

        .product-card h3 {
            margin: 16px 0 8px;
        }

        .product-card p {
            margin: 8px 0;
        }

        .product-card .price {
            font-size: 20px;
            color: #4CAF50;
            margin: 8px 0;
        }

        .product-card .quantity {
            font-size: 16px;
            color: #888;
            margin: 8px 0;
        }

        .order-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            width: calc(100% - 32px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .customer-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px;
            width: calc(100% - 32px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        @media only screen and (max-width: 1200px) {
            .product-card {
                width: calc(33.33% - 32px);
            }
        }

        @media only screen and (max-width: 800px) {
            .product-card {
                width: calc(50% - 32px);
            }
        }

        @media only screen and (max-width: 600px) {
            .product-card {
                width: 100%;
            }
        }

        .chart-container {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="logosec">
            <div class="logo">GreeneryGrove</div>
            <img src="https://img.icons8.com/ios-glyphs/30/000000/menu--v1.png" class="icn menuicn" id="menuicn"
                alt="menu-icon">
        </div>

        <div class="searchbar">
            <input type="text" placeholder="Search">
            <div class="searchbtn">
                <img src="https://img.icons8.com/ios-glyphs/30/000000/search--v1.png" class="icn srchicn"
                    alt="search-icon">
            </div>
        </div>

        <div class="message">
            <div class="circle"></div>
            <img src="https://img.icons8.com/ios-filled/50/000000/chat--v1.png" class="icn" alt="">
            <div class="dp">
                <img src="https://img.icons8.com/ios-filled/50/000000/user--v1.png" class="dpicn" alt="dp">
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="navcontainer">
            <nav class="nav">
                <div class="nav-upper-options">
                    <div class="nav-option option1" onclick="showSection('dashboard-section')">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M3 13h2v-2H3v2zm3 4h2v-2H6v2zm0-8h2V7H6v2zm2 4h2v-2H8v2zm-4 8h2v-2H4v2zm8-8h2v-2h-2v2zm0 4h2v-2h-2v2zm-4-4h2v-2H8v2zm8-4h2V7h-2v2zm0 8h2v-2h-2v2zm0 4h2v-2h-2v2zm4-8h2v-2h-2v2zm0 4h2v-2h-2v2zm2-12h2V3h-2v2zM4 5H2v2h2V5zm16 0h-2v2h2V5zm0 4h-2v2h2V9zm0 8h2v-2h-2v2zm-8-8h2V7h-2v2zm-4-4h2V3H8v2zm4 12h2v-2h-2v2zm0-4h2v-2h-2v2zm4-4h2V7h-2v2z" />
                        </svg>
                        <h3>Dashboard</h3>
                    </div>
                    <div class="nav-option option2" onclick="showSection('products-section')">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M12 2C8.14 2 5 5.14 5 9c0 2.45 1.52 4.55 3.68 5.55L12 22l3.32-7.45C17.48 13.55 19 11.45 19 9c0-3.86-3.14-7-7-7zm-1 10H9v-1h2v1zm4 0h-2v-1h2v1zm.82-2H7.18C6.39 9.66 6 8.36 6 7c0-3.31 2.69-6 6-6s6 2.69 6 6c0 1.36-.39 2.66-1.18 3zm-2.69-1h1.52c.32-.57.35-1.23.13-1.75H10.6a1.776 1.776 0 0 0-.38 1.75h2.91zM10 7h4v2h-4V7z" />
                        </svg>
                        <h3>Plants</h3>
                    </div>
                    <div class="nav-option option3" onclick="showSection('orders-section')">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M7 6V4H5v2h2zm4-2v2h2V4h-2zm-8 4v2h2V8H3zm16-2v2h2V6h-2zM3 14v2h2v-2H3zm16 0v2h2v-2h-2zM3 18v2h2v-2H3zm16 0v2h2v-2h-2zM1 2v2h22V2H1zm4 16v2h2v-2H5zm16 2v2h2v-2h-2zm-8 0v2h2v-2h-2zm-8-2v2h2v-2H5zm16-8v2h2v-2h-2zm0 4v2h2v-2h-2z" />
                        </svg>
                        <h3>Orders</h3>
                    </div>
                    <div class="nav-option option4" onclick="showSection('customers-section')">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M12 2a9.96 9.96 0 0 1 5.43 1.61 1 1 0 1 1-1.14 1.63A8.003 8.003 0 0 0 4 12a8.003 8.003 0 0 0 13.28 6.26 1 1 0 1 1 1.15 1.64A9.96 9.96 0 0 1 12 22C6.48 22 2 17.52 2 12S6.48 2 12 2zm0 2c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6s6-2.69 6-6c0-3.31-2.69-6-6-6zm1 6v2H9v-2h4zm-4-4v2h4V6H9zm4 6v2H9v-2h4z" />
                        </svg>
                        <h3>Customers</h3>
                    </div>
                    <div class="nav-option option5" onclick="showSection('add-plant-section')">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M12 2C8.14 2 5 5.14 5 9c0 2.45 1.52 4.55 3.68 5.55L12 22l3.32-7.45C17.48 13.55 19 11.45 19 9c0-3.86-3.14-7-7-7zm0 12h-2v-1h2v1zm-2 2h2v-1h-2v1zm0-4h2v-1h-2v1zm2-4h-2v1h2V8zm0 2h-2v1h2v-1zm0-4h-2v1h2V6zm0 2h-2v1h2V8zm-4 6h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zM8 6h2V5H8v1zm0 2h2V7H8v1zm0 2h2V9H8v1zm0-4h2V5H8v1zm0 2h2V7H8v1zm0 2h2V9H8v1zm2 4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zm-4-2h2v-1H8v1zm0-4h2v-1H8v1zm4 4h2v-1h-2v1zm2 2h2v-1h-2v1zM6 8V7H5v1h1zm-1-2h1V5H5v1zm1 2H5v1h1V8zm0-4H5v1h1V4zm1-2H5v1h1V2zm2 2h2V3H8v1zm-1-2h2V1H8v1zm-1-1h2V0H8v1zm2 1h2V1h-2v1zm1-1h2V0h-2v1zm1 0h2V0h-2v1zm2 0h2V0h-2v1zm2 0h2V0h-2v1zm2 0h2V0h-2v1zm2 0h2V0h-2v1zm2 0h2V0h-2v1z" />
                        </svg>
                        <h3>Add Plant</h3>
                    </div>
                    <div class="nav-option logout" onclick="logout()">
                        <svg class="nav-img" width="24" height="24" viewBox="0 0 24 24">
                            <path d="M17 1H7C5.9 1 5 1.9 5 3v4h2V4h10v16H7v-3H5v4c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm-6 8V6h2v3h4l-5 5-5-5h4z" />
                        </svg>
                        <h3><a href="https://greenerygrove.onrender.com/adminlogin/auth/logout"
                                style="text-decoration: none ;color:black; ">Logout</a> </h3>
                    </div>
                </div>
            </nav>
        </div>
        <div class="main">
            <div id="dashboard-section" class="section active">
                <div class="searchbar2">
                    <input type="text" name="" id="" placeholder="Search">
                    <div class="searchbtn">
                        <img src="https://img.icons8.com/ios-glyphs/30/000000/search--v1.png" class="icn srchicn"
                            alt="search-button">
                    </div>
                </div>
                <div class="box-container">
                    <div class="box box1">
                        <div class="text">
                            <h2 class="topic-heading"></h2>
                            <h2 class="topic">Most Sold out Plant</h2>
                        </div>
                        <img src="https://img.icons8.com/ios-filled/50/000000/visible.png" alt="Views">
                    </div>
                    <div class="box box2">
                        <div class="text">
                            <h2 class="topic-heading"></h2>
                            <h2 class="topic">Future Scope</h2>
                        </div>
                        <img src="https://img.icons8.com/ios-filled/50/000000/facebook-like.png" alt="Likes">
                    </div>
                    <div class="box box4">
                        <div class="text">
                            <h2 class="topic-heading"></h2>
                            <h2 class="topic">Orders</h2>
                        </div>
                        <img src="https://img.icons8.com/ios-filled/50/000000/purchase-order.png" alt="Orders">
                    </div>
                </div>
                <div>
                    <button id="visualizeButton"><a style="text-decoration:none;color: white;" href="">Visualize the sales</a></button>
                </div>
                <div>
                    <button id="downloadButton"><a style="text-decoration:none;color: white;" href="">Download the sales</a></button>
                </div>
            </div>
            <div id="products-section" class="section data2">
                <!-- Example product cards -->
                <div class="product-card">
                    <img src="https://via.placeholder.com/150" alt="Plant Image">
                    <h3>Plant Name</h3>
                    <p>Description of the plant goes here.</p>
                    <p class="price">$19.99</p>
                    <p class="quantity">Available: 10</p>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders-section" class="section data3">
                <h2>Orders</h2>
                <!-- Example order cards -->
                <div class="order-card">Order 1</div>
                <div class="order-card">Order 2</div>
            </div>

            <!-- Customers Section -->
            <div id="customers-section" class="section">
                <h2>Customers</h2>
                <!-- Example customer cards -->
                <div class="customer-card">

                </div>
            </div>

            <!-- Add Plant Section -->
            <div id="add-plant-section" class="section">
                <h2>Add Plant</h2>
                <div class="container">
                    <form id="plantForm" method="POST" action="https://greenerygrove.onrender.com/insert">
                        <label for="name">Plant Name</label>
                        <input type="text" id="name" name="name" required>

                        <label for="description">Description</label>
                        <textarea id="description" name="description"></textarea>

                        <label for="price">Price</label>
                        <input type="number" id="price" name="price" required>

                        <label for="quantityAvailable">Quantity Available</label>
                        <input type="number" id="quantityAvailable" name="quantityAvailable" required>

                        <label for="images">Images (URLs, comma separated)</label>
                        <input type="text" id="images" name="images">

                        <button type="submit">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Show specific section
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // Logout function
        function logout() {
            console.log('Logging out...');
        }

        // Extract IDs from URL
        function extractIdsFromUrl(url) {
            const parts = url.split('/');
            const id1 = parts[parts.length - 3];
            const id2 = parts[parts.length - 1];
            return [id1, id2];
        }

        // Fetch plant data
        function fetchPlantData() {
            const [id1, id2] = extractIdsFromUrl(window.location.href);
            const url = `https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}/getall`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.plants && Array.isArray(data.plants)) {
                        const productSection = document.querySelector(".data2");
                        productSection.innerHTML = data.plants.map(plant => `
                            <div class="product-card">
                                <img src="${plant.images[0]}" alt="Plant Image">
                                <h3>${plant.name}</h3>
                                <p>${plant.description}</p>
                                <p class="price">${plant.price}</p>
                                <p class="quantity">${plant.quantityAvailable}</p>
                            </div>
                        `).join('');
                    } else {
                        console.error('Expected "plants" array in response, but got:', data);
                    }
                })
                .catch(error => console.error('Error fetching plant data:', error));
        }

        let totalOrders = 0;

        // Fetch order data
        function fetchOrderData() {
            const orderId = extractIdsFromUrl(window.location.href)[1];
            const url = `https://greenerygrove.onrender.com/order/get/admin/${orderId}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const orderSection = document.querySelector(".data3");
                        orderSection.innerHTML = data.map(order => {
                            totalOrders++;
                            const itemsHtml = order.items.map(item => `
                                <li>${item.product} - ${item.quantity} x $${item.price.toFixed(2)}</li>
                            `).join('');
                            return `
                                <div class="order-card">
                                    <h3>Order ID: ${order._id}</h3>
                                    <p>User ID: ${order.user}</p>
                                    <p>Total Amount: $${order.totalAmount.toFixed(2)}</p>
                                    <p>Status: ${order.status}</p>
                                    <div>Shipping Address:</div>
                                    <p>${order.shippingAddress.street}, ${order.shippingAddress.city}, ${order.shippingAddress.state}, ${order.shippingAddress.postalCode}, ${order.shippingAddress.country}</p>
                                    <div>Items:</div>
                                    <ul>${itemsHtml}</ul>
                                </div>
                            `;
                        }).join('');
                    } else {
                        console.error('Expected array in response, but got:', data);
                    }
                })
                .catch(error => console.error('Error fetching order data:', error));
        }

        // Fetch analytics data
        function fetchAnalyticsData() {
            const [id1, id2] = extractIdsFromUrl(window.location.href);
            const url = `https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}/predict-sales`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    fetchPlantDetails(data.most_sold_plant_id_past, 'past', data.most_sold_quantity_past);
                    fetchPlantDetails(data.most_sold_plant_id_future, 'future', data.predicted_quantity_future);
                    // generateSalesCharts();
                })
                .catch(error => console.error('Error fetching analytics data:', error));
        }

        // Fetch plant details
        function fetchPlantDetails(plantId, period, quantity) {
            const url = `https://greenerygrove.onrender.com/getone/${plantId}`;

            fetch(url)
                .then(response => response.json())
                .then(data => updateDashboard(data.name, period, quantity))
                .catch(error => console.error('Error fetching plant details:', error));
        }

        // Update dashboard
        function updateDashboard(plantName, period, quantity) {
            if (period === 'past') {
                document.querySelector('.box1 .topic-heading').innerText = `${quantity} units`;
                document.querySelector('.box1 .topic').innerText = `Most Sold (Past): ${plantName}`;
            } else if (period === 'future') {
                document.querySelector('.box2 .topic-heading').innerText = `${quantity} units`;
                document.querySelector('.box2 .topic').innerText = `Predicted Most Sold: ${plantName}`;
            }
            document.querySelector('.box4 .topic-heading').innerText = `${totalOrders} units`;
        }

        // Fetch sales data
        async function fetchSalesData() {
            try {
                const [id1, id2] = extractIdsFromUrl(window.location.href);
                const response = await fetch(`https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}`);
                console.log(response);
                const data = await response.json();
                console.log('Fetched sales data:', data);
                return data.sales_last_30_days;
            } catch (error) {
                console.error('Error fetching sales data:', error);
                return [];
            }
        }

        // Create chart
        function createChart(data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const labels = data.map(item => item.plant_name);
            const quantities = data.map(item => item.quantity);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity Sold',
                        data: quantities,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Generate sales charts
        function generateSalesCharts() {
            // fetchSalesData().then(data => {
            //     if (data && Array.isArray(data)) {
            //         createChart(data);
            //     } else {
            //         console.error('Sales data is not in the expected format:', data);
            //     }
            // });
        }

        // Fetch and display visualization data
        async function fetchVisualizationData() {
            try {
                const [id1, id2] = extractIdsFromUrl(window.location.href);
                const response = await fetch(`https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}/visualize`);
                if (!response.ok) {
                    throw new Error('Failed to fetch sales data');
                }
                const data = await response.json();
                console.log('Fetched visualization data:', data);
                const salesData = data.salesData;
                const imageData = data.imageData;

                if (Array.isArray(salesData)) {
                    const salesDataContainer = document.getElementById('sales-data');
                    salesData.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = `${item.plant_name}: ${item.quantity}`;
                        salesDataContainer.appendChild(div);
                    });
                } else {
                    console.error('Sales data is not in the expected format:', salesData);
                }

                const salesImage = document.getElementById('sales-image');
                salesImage.src = `data:image/png;base64,${imageData}`;
            } catch (error) {
                console.error('Error fetching sales data:', error);
            }
        }

        async function fetchCustomerData() {
            try {
                const [id1, id2] = extractIdsFromUrl(window.location.href);
                const url = `https://greenerygrove.onrender.com/order/get/admin/customer/${id2}`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch customer data');
                }
                const data = await response.json();
                updateCustomerSection(data);
            } catch (error) {
                console.error('Error fetching customer data:', error);
            }
        }

        // Update customer section with fetched data
        function updateCustomerSection(data) {
            const customerSection = document.getElementById('customers-section');
            customerSection.innerHTML = '<h2>Customers</h2>'; // Reset content with header

            if (Object.keys(data).length === 0) {
                customerSection.innerHTML += '<div class="customer-card">No customers found</div>';
                return;
            }

            for (const [userId, user] of Object.entries(data)) {
                const customerCard = document.createElement('div');
                customerCard.classList.add('customer-card');
                customerCard.innerHTML = `
                    <h3>${user.name}</h3>
                    <p>Email: ${user.email}</p>
                    <p>Phone: ${user.phone}</p>
                    <p>Address: ${user.address}</p>
                `;
                customerSection.appendChild(customerCard);
            }
        }

        // Initialize functions on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard-section');
            fetchPlantData();
            fetchOrderData();
            fetchAnalyticsData();
            fetchCustomerData();
            // fetchVisualizationData();
        });

        function updateButtonUrls() {
            const [id1, id2] = extractIdsFromUrl(window.location.href);
            const visualizeButton = document.getElementById('visualizeButton').querySelector('a');
            const downloadButton = document.getElementById('downloadButton').querySelector('a');

            visualizeButton.href = `https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}/visualize`;
            downloadButton.href = `https://greenerygrove.onrender.com/admin/dashboard/${id1}/nursery/${id2}/dcsv`;
        }

        // Call fetchSalesData to initiate the process
        updateButtonUrls();
    </script>
</body>

</html>
